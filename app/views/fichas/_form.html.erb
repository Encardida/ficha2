<%= form_for @ficha, :html => { :class => "form-horizontal ficha" } do |f| %>

  <% if @ficha.errors.any? %>
    <div id="error_expl" class="panel panel-danger">
      <div class="panel-heading">
        <h3 class="panel-title"><%= pluralize(@ficha.errors.count, "error") %> prohibited this ficha from being saved:</h3>
      </div>
      <div class="panel-body">
        <ul>
        <% @ficha.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
        </ul>
      </div>
    </div>
  <% end %>


  <div class="container">
  	<div class="modal fade" id="modal-1">
  		<div class="modal-dialog modal-xs">
  			<div class="modal-content">
  				 <div class="modal-header">
  				 	<button type="button" class="close" data-dismiss="modal">&times;</button>
  				 	<h3 class="modal-title">Copiar ficha</h3>
  				 </div>

  				 <div class="modal-body">

           <% if !@ficha.id.blank? %>
           <table class="table table-striped">
             <thead>
               <tr class="header">
                 <th><%= t('teacher') %></th>
                 <th><center><%= t('team') %></center></th>
                 <th><center><%= t('semester') %></center></th>
                 <th  width="5%"><center> <%=t '.actions', :default => t("helpers.actions") %> </center> </th>
               </tr>
             </thead>

             <tbody id="tbody">
              <% getEquivalent(@ficha).each do |ficha| %>
                <tr>
                  <td><%= ficha.user.name %></td>
                  <td><center><%= ficha.team %></center></td>
                  <td><center><%= getSemester(ficha) %></center></td>
                  <td id="actions">
                    <center>
                      <%= link_to duplicate_button.html_safe, copy_fichas_path(@ficha, ficha), :class => 'btn btn-default btn-sm',
                      :id =>"copy_bt", title: 'Copiar', 'data-toggle' => 'tooltip', 'data-placement' => 'right' %>
                    </center>
                  </td>
                </tr>
              <% end %>
             </tbody>

           </table>
           <% end %>

           </div>

  				 <div class="modal-footer">
  				 	<a href="" class="btn btn-default" data-dismiss="modal">Close</a>
  				 </div>
  			</div>
  		</div>
  	</div>
  </div>

  <div class="container">
  	<div class="modal fade" id="modal-2">
  		<div class="modal-dialog modal-xs">
  			<div class="modal-content">
  				 <div class="modal-header">
  				 	<button type="button" class="close" data-dismiss="modal">&times;</button>
  				 	<h3 class="modal-title">Atualizar Ficha</h3>
  				 </div>
  				 <div class="modal-body">
             <p align="justify">Ao atualizar esta <b>ficha</b> ela será enviada para avaliação somente quando <b>todos os campos</b> forem devidamente preenchidos.
            </p>
            <p>
             Caso contrário, ela permanecerá disponível apenas a você para que a <b>altere mais tarde</b>.
             </p>
           </div>

  				 <div class="modal-footer">
  				 	<a href="" class="btn btn-primary" data-dismiss="modal">Close</a>
  				 </div>
  			</div>
  		</div>
  	</div>
  </div>


  <div class="panel panel-default">

    <header class="panel-heading header"><%= t('details') %></header>
    <br>


  <% if @show or user_appriser %>
    <div class="form-group">
      <%= f.label :semester, :class => 'control-label col-lg-3' %>
      <div class="col-lg-2">
        <%= f.text_field 'year', :value => getSemester(@ficha), :class => 'form-control', :autocomplete => "off", :readonly => can_not_edit(@ficha) %>
      </div>
    </div>

    <div class="form-group">
      <%= f.label :matter, :class => 'control-label col-lg-3' %>
      <div class="col-lg-7">
        <%= f.text_field 'matter_name', :value => @ficha.matter.code, :class => 'form-control', :autocomplete => "off", :readonly => can_not_edit(@ficha) %>
      </div>

      <div class="col-lg-1">
        <%= f.text_field 'team', :value => @ficha.team, :class => 'form-control', :autocomplete => "off", :readonly => can_not_edit(@ficha) %>
      </div>

    </div>

    <div class="form-group">
      <%= f.label :teacher, :class => 'control-label col-lg-3' %>
      <div class="col-lg-8">
        <%= f.text_field 'user_name', :value => @ficha.user.name, :class => 'form-control', :autocomplete => "off", :readonly => can_not_edit(@ficha) %>
      </div>
    </div>

  <% else %>

    <div class="form-group">
      <%= f.label :semester, :class => 'control-label col-lg-3', :for => "select_year" %>

      <div class="col-lg-8">
        <%= select("ficha", "semester", %w(1 2)) %>
        <span> / </span>
        <%= f.select :year, (Time.zone.now.year - 10)..(Time.zone.now.year + 1) %>

        <% if !@ficha.id.blank? and hasEquivalent(@ficha) %>
          <button action='' type="button" class="btn btn-default btn-sm"
          data-toggle="modal" data-target="#modal-1" title='Copiar' data-placement:='right'><%= duplicate_button.html_safe %></button>
        <% end %>

      </div>

      <%=f.error_span(:year) %>
      <%=f.error_span(:semester) %>
    </div>

    <div class="form-group">
      <%= f.label :matter, :class => 'control-label col-lg-3' %>
      <div class="col-lg-8">
        <%= f.collection_select(:matter_id, matters_order, :id, :code, {:include_blank => true} , { :data_href => "x"}) %>
          <span id='matter_show'></span>
        <%=f.error_span(:matter) %>
      </div>
    </div>

    <div class="form-group">
      <%= f.label :team, :class => 'control-label col-lg-3' %>
      <div class="col-lg-1">
        <%= f.text_field 'team', :value => @ficha.team, :class => 'form-control', :autocomplete => "off"%>

        <%=f.error_span(:team) %>
      </div>
    </div>

    <% if current_user.admin? and !@show%>

      <div class="form-group">
        <%= f.label :teacher, :class => 'control-label col-lg-3' %>
        <div class="col-lg-8">
          <%= f.collection_select(:user_id, users_order, :id, :name, include_blank: true) %>
          <%=f.error_span(:user) %>
        </div>
      </div>

    <% end %>
  <% end %>

  <div class="form-group">
    <%= f.label :program, :class => 'control-label col-lg-3' %>
    <div class="col-lg-8" id="div_program">
      <%= f.text_area :program, :class => 'form-control resize', rows: count_lines(@ficha.program), :readonly => can_not_edit(@ficha) %>
      <span id="program_error" class="error_mensage" role="alert"> </span>
      <%=f.error_span(:program) %>
    </div>
  </div>

  <div class="form-group">
    <%= f.label :general_objective, :class => 'control-label col-lg-3' %>
    <div class="col-lg-8" id="div_objective">
      <%= f.text_area :general_objective, :class => 'form-control resize', rows: count_lines(@ficha.general_objective), :readonly => can_not_edit(@ficha) %>
      <span id="objective_error" class="error_mensage" role="alert"> </span>
      <%=f.error_span(:general_objective) %>
    </div>
  </div>

  <div class="form-group">
    <%= f.label :specific_objective, :class => 'control-label col-lg-3' %>
    <div class="col-lg-8" id="div_specific_objective">
      <%= f.text_area :specific_objective, :class => 'form-control resize', rows: count_lines(@ficha.specific_objective), :readonly => can_not_edit(@ficha) %>
          <span id="specific_objective_error" class="error_mensage" role="alert"> </span>
          <%=f.error_span(:specific_objective) %>
    </div>
  </div>


  <div class="form-group">
    <%= f.label :didactic_procedures, :class => 'control-label col-lg-3' %>
    <div class="col-lg-8" id="div_procedures">
      <%= f.text_area :didactic_procedures, :class => 'form-control resize', rows: count_lines(@ficha.didactic_procedures), :readonly => can_not_edit(@ficha)%>
      <span id="procedures_error" class="error_mensage" role="alert"> </span>
      <%=f.error_span(:didactic_procedures) %>
    </div>
  </div>

  <div class="form-group">
    <%= f.label :evaluation, :class => 'control-label col-lg-3' %>
    <div class="col-lg-8" id="div_evaluation">
      <%= f.text_area :evaluation, :class => 'form-control resize', rows: count_lines(@ficha.evaluation), :readonly => can_not_edit(@ficha) %>
      <span id="evaluation_error" class="error_mensage" role="alert"> </span>
      <%=f.error_span(:evaluation) %>
    </div>
  </div>

  <div class="form-group">
    <%= f.label :basic_bibliography, :class => 'control-label col-lg-3' %>
    <div class="col-lg-8" id="div_basic_bibliography">
      <%= f.text_area :basic_bibliography, :class => 'form-control resize', rows: count_lines(@ficha.basic_bibliography), :readonly => can_not_edit(@ficha) %>
      <span id="basic_bibliography_error" class="error_mensage" role="alert"> </span>
      <%=f.error_span(:basic_bibliography) %>
    </div>
  </div>

  <div class="form-group">
    <%= f.label :bibliography, :class => 'control-label col-lg-3' %>
    <div class="col-lg-8" id="div_bibliography">
      <%= f.text_area :bibliography, :class => 'form-control resize', rows: count_lines(@ficha.bibliography), :readonly => can_not_edit(@ficha) %>
      <span id="bibliography_error" class="error_mensage" role="alert"> </span>
      <%=f.error_span(:bibliography) %>
    </div>
  </div>

</div>


<% if user_signed_in? and ((@ficha.status == "Reprovado" && current_user.teacher?) || !current_user.teacher?)  %>

  <div class="panel panel-default">
    <header class="panel-heading header"><%= t('confirmation') %></header>
    <br>

  <% if current_user.teacher? or (@ficha.status == "Aprovado") or @show %>

    <div class="form-group">
      <%= f.label :status, :class => 'control-label col-lg-3' %>
      <div class="col-lg-3">
        <%= f.text_field 'ficha_status', :value => @ficha.status, :class => 'form-control', :readonly => true %>
      </div>
    </div>

  <%else %>

    <div class="form-group">
      <%= f.label :status, :class => 'control-label col-lg-3' %>
      <div class="col-lg-8" id='select_status'>

        <%= f.select("status", %w(Editando Reprovado Aprovado Enviado)) %>

        <span id="ficha_status_icon"> <%= status_representation(@ficha.status).html_safe %> <span>

      <% if @ficha.status != "Reprovado"%>
        <script type="text/javascript">
          $("#appraisal_show").hide();
        </script>
      <% end %>

      </div>
      <%=f.error_span(:status) %>
    </div>

  <% end %>

  <% if @ficha.status != 'Aprovado' %>

  <div class="form-group" id='appraisal_show'>

    <%= f.label :appraisal, :class => 'control-label col-lg-3' %>
    <div class="col-lg-8">
      <%= f.text_area :appraisal, :class => 'form-control resize', rows: count_lines(@ficha.appraisal), :readonly => (current_user.teacher? or @show) %>
    </div>
    <%=f.error_span(:appraisal) %>

  </div>

 <% end %>

  </div>
<% end %>

  <% if(!@show) %>
    <div class="form-group">
      <div class="col-lg-offset-2 col-lg-10">

        <button action='' type="button" class="btn btn-default btn-sm"
        data-toggle="modal" data-target="#modal-2" title='Adicionar' data-placement:='right'><%= help_button.html_safe %></button>

        <%= f.submit nil, :class => 'btn btn-primary' %>

        <%= link_to t('.cancel', :default => t("helpers.links.cancel")),
                  fichas_path, :class => 'btn btn-default' %>
      </div>
    </div>
  <% end %>

<% end %>
